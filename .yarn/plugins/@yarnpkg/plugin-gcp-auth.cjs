/* eslint-disable */
//prettier-ignore
module.exports = {
name: "@yarnpkg/plugin-gcp-auth",
factory: function (require) {
var plugin=(()=>{var w=Object.create,c=Object.defineProperty;var y=Object.getOwnPropertyDescriptor;var C=Object.getOwnPropertyNames;var x=Object.getPrototypeOf,T=Object.prototype.hasOwnProperty;var A=t=>c(t,"__esModule",{value:!0});var a=t=>{if(typeof require!="undefined")return require(t);throw new Error('Dynamic require of "'+t+'" is not supported')};var H=(t,e)=>{for(var o in e)c(t,o,{get:e[o],enumerable:!0})},P=(t,e,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of C(e))!T.call(t,n)&&n!=="default"&&c(t,n,{get:()=>e[n],enumerable:!(o=y(e,n))||o.enumerable});return t},s=t=>P(A(c(t!=null?w(x(t)):{},"default",t&&t.__esModule&&"default"in t?{get:()=>t.default,enumerable:!0}:{value:t,enumerable:!0})),t);var I={};H(I,{default:()=>D});var i=s(a("@yarnpkg/core")),h=s(a("@yarnpkg/cli"));var p=s(a("@yarnpkg/core"));var l=s(a("@yarnpkg/core"));async function d(t,e){let o=await l.httpUtils.post("https://www.googleapis.com/oauth2/v1/tokeninfo",{access_token:e},{configuration:t});return JSON.parse(o.toString())}var k=s(a("@yarnpkg/core"));async function g(t,...e){let{stdout:o,stderr:n}=await k.execUtils.execvp("gcloud",e,{cwd:t.projectCwd,encoding:"utf-8"});if(n)throw n;return o}async function f(t){let e,o;try{({access_token:e,expires_in:o}=(await p.httpUtils.request("http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token",null,{configuration:t,headers:{"Metadata-Flavor":"Google"},jsonResponse:!0})).body),e=e.trim()}catch{try{e=await g(t,"auth","application-default","print-access-token")}catch{e=await g(t,"auth","print-access-token")}e=e.trim().split(`
`).filter(u=>u&&u!=="").pop(),{expires_in:o}=await d(t,e)}let n=Date.now()+o*1e3,r={token:e,expiresAt:n};return await p.Configuration.updateHomeConfiguration({gcpAccessToken:r}),e}var v={gcpAccessToken:{description:"",type:i.SettingsType.SHAPE,properties:{token:{description:"",type:i.SettingsType.STRING,default:null},expiresAt:{description:"",type:i.SettingsType.NUMBER,default:null}}}},m,M={configuration:v,hooks:{async getNpmAuthenticationHeader(t,e,{configuration:o}){if(!e.includes("npm.pkg.dev/"))return null;let n=o.get("gcpAccessToken"),r=n.get("token");return(!r||n.get("expiresAt")<Date.now()+1e3)&&(r=await f(o)),`Bearer ${r}`}},commands:[(m=class extends h.BaseCommand{async execute(){this.context.stdout.write(`Discarding plugin cache...
`),await i.Configuration.updateHomeConfiguration({gcpAccessToken:{}}),this.context.stdout.write(`Rebuilding...
`),await f(await i.Configuration.find(this.context.cwd,this.context.plugins)),this.context.stdout.write(`Done!
`)}},m.paths=[["gcp-auth","refresh"]],m)]},D=M;return I;})();
return plugin;
}
};
